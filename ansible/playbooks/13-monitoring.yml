---
- name: Install kube-prometheus-stack (Prometheus + Grafana)
  hosts: control_plane[0]
  become: yes
  tasks:
    - name: Add Prometheus Community Helm repository
      command: helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
      changed_when: false

    - name: Update Helm repositories
      command: helm repo update
      changed_when: false

    - name: Check if monitoring namespace exists
      command: kubectl get namespace monitoring
      register: monitoring_ns
      changed_when: false
      failed_when: false

    - name: Create monitoring namespace
      command: kubectl create namespace monitoring
      when: monitoring_ns.rc != 0

    - name: Create kube-prometheus-stack values file
      copy:
        dest: /tmp/kube-prometheus-values.yaml
        content: |
          # Prometheus Configuration
          prometheus:
            prometheusSpec:
              retention: {{ prometheus_retention }}
              storageSpec:
                volumeClaimTemplate:
                  spec:
                    storageClassName: local-path
                    accessModes: ["ReadWriteOnce"]
                    resources:
                      requests:
                        storage: {{ prometheus_storage_size }}
              resources:
                requests:
                  cpu: 500m
                  memory: 2Gi
                limits:
                  cpu: 2000m
                  memory: 4Gi

            ingress:
              enabled: true
              ingressClassName: nginx
              hosts:
                - prometheus.{{ base_domain }}
              annotations:
                cert-manager.io/cluster-issuer: "letsencrypt-prod"
              tls:
                - secretName: prometheus-tls
                  hosts:
                    - prometheus.{{ base_domain }}

          # Grafana Configuration
          grafana:
            enabled: true
            adminPassword: "{{ grafana_admin_password }}"

            persistence:
              enabled: true
              storageClassName: local-path
              size: 10Gi

            ingress:
              enabled: true
              ingressClassName: nginx
              hosts:
                - grafana.{{ base_domain }}
              annotations:
                cert-manager.io/cluster-issuer: "letsencrypt-prod"
              tls:
                - secretName: grafana-tls
                  hosts:
                    - grafana.{{ base_domain }}

            resources:
              requests:
                cpu: 100m
                memory: 256Mi
              limits:
                cpu: 500m
                memory: 512Mi

            # Additional Grafana dashboards
            dashboardProviders:
              dashboardproviders.yaml:
                apiVersion: 1
                providers:
                - name: 'default'
                  orgId: 1
                  folder: ''
                  type: file
                  disableDeletion: false
                  editable: true
                  options:
                    path: /var/lib/grafana/dashboards/default

          # AlertManager Configuration
          alertmanager:
            alertmanagerSpec:
              storage:
                volumeClaimTemplate:
                  spec:
                    storageClassName: local-path
                    accessModes: ["ReadWriteOnce"]
                    resources:
                      requests:
                        storage: 10Gi

            ingress:
              enabled: true
              ingressClassName: nginx
              hosts:
                - alertmanager.{{ base_domain }}
              annotations:
                cert-manager.io/cluster-issuer: "letsencrypt-prod"
              tls:
                - secretName: alertmanager-tls
                  hosts:
                    - alertmanager.{{ base_domain }}

          # Node Exporter
          nodeExporter:
            enabled: true

          # Kube State Metrics
          kubeStateMetrics:
            enabled: true

          # Service Monitors
          kubeApiServer:
            enabled: true
          kubeControllerManager:
            enabled: true
          kubeScheduler:
            enabled: true
          kubeEtcd:
            enabled: true
          kubelet:
            enabled: true
        mode: '0644'

    - name: Check if kube-prometheus-stack is already installed
      command: helm list -n monitoring
      register: helm_list
      changed_when: false

    - name: Install kube-prometheus-stack using Helm
      command: >
        helm install kube-prometheus-stack prometheus-community/kube-prometheus-stack
        --namespace monitoring
        --values /tmp/kube-prometheus-values.yaml
        --version {{ kube_prometheus_stack_version }}
        --wait
        --timeout 15m
      register: prometheus_install
      when: "'kube-prometheus-stack' not in helm_list.stdout"

    - name: Display kube-prometheus-stack installation output
      debug:
        var: prometheus_install.stdout_lines
      when: "'kube-prometheus-stack' not in helm_list.stdout"

    - name: Wait for Prometheus to be ready
      command: kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=prometheus -n monitoring --timeout=600s
      register: prometheus_ready
      retries: 3
      delay: 20
      until: prometheus_ready.rc == 0

    - name: Wait for Grafana to be ready
      command: kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=grafana -n monitoring --timeout=300s
      register: grafana_ready
      retries: 3
      delay: 10
      until: grafana_ready.rc == 0

    - name: Save monitoring configuration
      fetch:
        src: /tmp/kube-prometheus-values.yaml
        dest: "{{ playbook_dir }}/../configs/monitoring/kube-prometheus-values.yaml"
        flat: yes

    - name: Get monitoring pods
      command: kubectl get pods -n monitoring
      register: monitoring_pods
      changed_when: false

    - name: Display monitoring pods
      debug:
        var: monitoring_pods.stdout_lines

    - name: Get monitoring services
      command: kubectl get svc -n monitoring
      register: monitoring_services
      changed_when: false

    - name: Display monitoring services
      debug:
        var: monitoring_services.stdout_lines

    - name: Get Prometheus PVCs
      command: kubectl get pvc -n monitoring
      register: prometheus_pvcs
      changed_when: false

    - name: Display Prometheus PVCs
      debug:
        var: prometheus_pvcs.stdout_lines

    - name: Get Ingress resources in monitoring namespace
      command: kubectl get ingress -n monitoring
      register: monitoring_ingress
      changed_when: false

    - name: Display monitoring Ingress resources
      debug:
        var: monitoring_ingress.stdout_lines

    - name: Create ServiceMonitor for Cilium (if Hubble is enabled)
      copy:
        dest: /tmp/cilium-servicemonitor.yaml
        content: |
          apiVersion: v1
          kind: Service
          metadata:
            name: hubble-metrics
            namespace: kube-system
            labels:
              k8s-app: hubble
          spec:
            type: ClusterIP
            clusterIP: None
            ports:
            - name: hubble-metrics
              port: 9965
              protocol: TCP
              targetPort: 9965
            selector:
              k8s-app: cilium
          ---
          apiVersion: monitoring.coreos.com/v1
          kind: ServiceMonitor
          metadata:
            name: cilium-agent
            namespace: monitoring
          spec:
            selector:
              matchLabels:
                k8s-app: cilium
            namespaceSelector:
              matchNames:
              - kube-system
            endpoints:
            - port: hubble-metrics
              interval: 30s
              path: /metrics
        mode: '0644'
      when: enable_hubble | bool

    - name: Apply Cilium ServiceMonitor
      command: kubectl apply -f /tmp/cilium-servicemonitor.yaml
      when: enable_hubble | bool

    - name: Display success message
      debug:
        msg:
          - "==========================================="
          - "Monitoring Stack Installed Successfully!"
          - "==========================================="
          - "Components:"
          - "  - Prometheus (metrics collection)"
          - "  - Grafana (visualization)"
          - "  - AlertManager (alerting)"
          - "  - Node Exporter (node metrics)"
          - "  - Kube State Metrics (cluster metrics)"
          - ""
          - "Access URLs (after DNS configuration):"
          - "  - Prometheus: https://prometheus.{{ base_domain }}"
          - "  - Grafana: https://grafana.{{ base_domain }}"
          - "  - AlertManager: https://alertmanager.{{ base_domain }}"
          - ""
          - "Grafana Credentials:"
          - "  Username: admin"
          - "  Password: {{ grafana_admin_password }}"
          - ""
          - "Configuration saved to: configs/monitoring/kube-prometheus-values.yaml"
          - ""
          - "Next: Install Harbor Registry"
          - "==========================================="
