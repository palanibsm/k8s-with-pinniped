---
- name: Join Worker Nodes to Cluster
  hosts: workers
  become: yes
  tasks:
    - name: Check if node is already joined
      stat:
        path: /etc/kubernetes/kubelet.conf
      register: kubelet_conf

    - name: Copy join command to worker nodes
      copy:
        src: /tmp/join-command-worker.sh
        dest: /tmp/join-command.sh
        mode: '0755'
      when: not kubelet_conf.stat.exists

    - name: Join worker node to cluster
      shell: bash /tmp/join-command.sh
      register: join_output
      when: not kubelet_conf.stat.exists

    - name: Display join output
      debug:
        var: join_output.stdout_lines
      when: not kubelet_conf.stat.exists

    - name: Wait for node to be ready
      command: kubectl get nodes {{ node_name }}
      register: node_status
      retries: 30
      delay: 10
      until: node_status.rc == 0
      changed_when: false
      delegate_to: "{{ groups['control_plane'][0] }}"

    - name: Label worker nodes
      command: kubectl label nodes {{ node_name }} node-role.kubernetes.io/worker=worker --overwrite
      changed_when: false
      delegate_to: "{{ groups['control_plane'][0] }}"

- name: Verify All Workers Joined
  hosts: control_plane[0]
  become: yes
  tasks:
    - name: Get all nodes with labels
      command: kubectl get nodes --show-labels
      register: all_nodes
      changed_when: false

    - name: Display all nodes
      debug:
        var: all_nodes.stdout_lines

    - name: Get node details
      command: kubectl get nodes -o wide
      register: nodes_wide
      changed_when: false

    - name: Display node details
      debug:
        var: nodes_wide.stdout_lines

    - name: Display success message
      debug:
        msg:
          - "==========================================="
          - "All Worker Nodes Joined Successfully!"
          - "==========================================="
          - "Total Masters: {{ groups['control_plane'] | length }}"
          - "Total Workers: {{ groups['workers'] | length }}"
          - "Total Nodes: {{ (groups['control_plane'] | length) + (groups['workers'] | length) }}"
          - ""
          - "Next: Install Cilium CNI"
          - "==========================================="
